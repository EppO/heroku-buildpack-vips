#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

BUILD_DIR=$1
CACHE_DIR=$2
VIPS_VERSION="7.36.3"
VIPS_PACKAGE="vips-${VIPS_VERSION}.tgz"
S3_BUCKET="heroku-buildpack-vips"
S3_URL="https://s3.amazonaws.com/${S3_BUCKET}/${VIPS_PACKAGE}"

echo "-----> Installing libvips like a boss"

# change to the the BUILD_DIR ($1)
cd $1

# download the vips binary (-O) silently (-s)
curl $S3_URL -s -O

echo "Download completed"

# make a directory to untar (like unzip) the binary
mkdir -p vendor/libvips

# untar the binary to the directory we want
tar -C vendor/libvips -xf $VIPS_PACKAGE 

mkdir -p "$BUILD_DIR/bin/"
cp vendor/libvips/bin/* "$BUILD_DIR/bin/"

echo "Installation completed"

echo "Building runtime environment for vips"
mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\"\$HOME/bin:\$PATH\"" > $BUILD_DIR/.profile.d/vips.sh
echo "export LD_RUN_PATH=\"$BUILD_DIR/vendor/libvips/lib:\$LD_RUN_PATH\"" > $BUILD_DIR/.profile.d/vips.sh
